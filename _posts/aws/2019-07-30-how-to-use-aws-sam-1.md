---
layout: post
title: AWS SAM을 사용하는 방법 (1)
subtitle: SAM이 대체 무엇인가
comments: true
categories: ["Tech"]
tag: ["AWS", "SAM", "Beginner"]
---

## AWS가 무엇을 했을까

듣기로는 아마존은 처음 온라인서점 사이트를 운영하면서 온라인 쇼핑몰로 사업규모를 확장해갔고, 그 온라인 쇼핑몰을 안정적으로 운영하기위해 막대한 자본을 투입해 처음 클라우드 형태의 서비스 구성을 만들었다고 했다. 그러한 구성을 체계화 하고 이름을 붙여 진짜 사업으로 만들었던 것은 나중 일이었고, 사실 인터넷을 기반으로 하는 다양한 서비스들은 이미 그 전부터 이야기가 나오고 있었다. 

이야기가 다른데로 새기 전에 다시 돌아와보면, AWS(Amazon Web Service)는 이제 전 세계에서 가장 유명한 IaaS 클라우드 서비스에서 점점 영역을 넓혀가고 있다. 이미 EC2(Elastic Compute Cloud)를 활용하는 각종 서비스가 만들어져있고, 개발자들은 이제 그 서비스들을 이용해 서버개발과 운영에 대한 책임을 제거한 오로지 기능에만 집중할 수 있는 형태의 서비스를 개발했다. API Gateway-Lambda-RDS(and/or S3)를 연결하는 서비스는 이미 하나의 완전한 서비스인데 AWS는 한발 더 나아가 SQS라는 메시지 큐를 도입해 Lambda끼리의 연결까지도 가능하게 했고, CloudFormation이라는 서비스를 만들어서 그 모든것들을 하나의 묶음으로 관리할 수 있는 어플리케이션으로 만들었다.

SAM(Serverless Application Model)은 CloudFormation과는 다른 방향으로 서버리스 어플리케이션을 표현했다. CloudFormation은 AWS의 거의 모든 서비스를 다 가져와서 연결할수있는 Designer라는 도구를 제공하는데, 어플리케이션을 구성하는데는 필요하지 않은 것들도 상당히 많아서 실제로 사용하려하면 내가 사용하려는 서비스를 정확히 알고 있어야 하며, 그것들을 배치하고 서로 연결하는 방법을 이해하기까지 상당한 시간과 노력이 필요하다. 그에 반해 SAM은 주요 리소스와 이벤트를 이용해 어플리케이션을 표현할 수 있어서 훨씬 간결한 표현이 가능하다. 

## SAM이 무엇인가

위에서 설명했지만, SAM은 Serverless Application Model의 약자로, AWS의 여러 서비스들을 묶어 하나의 어플리케이션 모델을 생성하는 서비스를 말한다. 이 서비스는 하나의 Lambda를 중심으로 여러 리소스들을 연결할 때는 문제가 되지 않던 서비스 전반에 대한 구성을 이해하는 어려움을 해소하는데 도움을 준다. 

Lambda에 코드를 업로드 할 때는 직접 코드 편집기에서 코드를 제작한 뒤에 저장하거나 zip을 이용해 소스코드를 직접 업로드하기, 또는 S3에 코드를 업로드한 뒤에 S3 링크를 이용해 코드를 업로드하는 방식이었는데, SAM은 S3에 코드를 패키징해서 업로드한 뒤에, 그 코드를 CloudFormation에 올려 Stack으로 구성하도록 되어있다. 그러한 일련의 작업을 하도록 도와주는 프로그램이 SAM CLI이며, Eclipse 혹은 Jetbrains의 개발도구들에 플러그인 형태로 Toolkit을 제공한다. 개발자들은 이 Toolkit을 이용해서 손쉽게 코드를 배포하거나, 로컬 환경에서 테스트해볼 수 있다. SAM을 로컬 환경에서 테스트하기 위해서는 Docker가 필수이며, SAM CLI는 Docker 컨테이너를 리소스당 하나씩 생성해서 가상의 Serverless Application을 구축한다. 

## SAM을 왜 써야 할까

SAM을 쓰는 이유는 정말 다양하게 생각해볼 수 있다. 우선은 Lambda와 SQS, S3, DynamoDB, API Gateway들이 북잡하게 얽혀있는 경우에는 개별 구성만으로는 그 전체를 파악하는 것이 아주 힘들다. 전체를 파악하기 힘들면 관리도 당연히 힘들어지고, 관리가 힘들면 배포 버전을 관리하거나 환경구성을 관리하는것도 아주 힘들어진다. 만약 운영중인 서비스의 개발환경을 Test/Staging/Product 단계로 구축하거나, Blue Green 배포를 하려고 계획한다면 개발자는 Lambda 갯수만큼 배포 난이도가 수직상승 하는것을 경험하게 될 것이다.

다음으로는 CI/CD를 들 수가 있다. Lambda 함수들을 아무리 잘 정리한다 해도 개발자가 직접 Message들을 목업 데이터로 구축해서 테스트하려 든다면 실제 서비스에서 있을 수 있는 시나리오에 대비해 테스트셋을 구성하는게 아주 힘들어질 것이다. SAM은 로컬 환경에서의 테스트시에 AWS가 Docker hub에 배포해둔 각종 이미지들을 가져와서 자동으로 테스트환경을 만들어 미리 준비된 입력값을 이용해 Lambda를 테스트해준다. 그리고 해당 구성을 서비스에 업로드할 때도 모든 리소스를 한번에 업로드하고 구성까지 해주기 때문에 개발자가 손으로 하나하나 구성하다 빠뜨리는 실수를 할 위험이 훨씬 줄어들게 된다.

