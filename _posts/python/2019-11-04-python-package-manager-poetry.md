---
layout: post
title: 
subtitle: Poetry를 이용한 파이썬 개발환경 가상화
comments: true
categories: ["Python"]
tag: ["python", "virtualenv", "poetry"]
---

# 서론

## 가상환경이 필요한 이유

외부 의존성을 갖는 프로그램을 작성하는 경우에 각각의 외부 라이브러리들이 필요로 하는 라이브러리들의 버젼이 다른 경우가 있다. 파이썬도 마찬가지인데, 공통적으로 사용되는 패키지들이 있는가 하면 각 프로젝트마다 다른 버전이 사용되는 패키지들도 있다. 심지어 파이썬 버전이 다른 경우도 존재하는데, 예를 들어 A 프로젝트가 파이썬 3.5 버전을 기반으로 작성되었는데, B 프로젝트가 3.7 버전을 기반으로 작성되는 등의 경우에는 한 시스템에 두가지 이상의 파이썬을 설치하기도 한다.

이런 불편함을 해소하기 위해서 파이썬에는 3.3 버전부터 virtualenv 라고 하는 가상환경 관리자가 파이썬 프로젝트의 하위로 들어오게 되었다. 이걸 이용해서 프로젝트마다 개별 환경을 구성하고, 프로젝트별로 의존성을 기록해서 다른 사람과 공유할 수도 있게 되었다. 그런데 virtualenv가 좋긴 하지만 전역 환경에서 패키지 버전을 관리하는것과 다르지 않기 때문에 가상 환경에서 각 패키지들이 의존하는 패키지들의 버전이 충돌나는 경우가 생기는 경우가 많았다. 

그런 이유로 다양한 가상환경과 패키지 관리자가 만들어졌다. Pipenv, Anaconda, Poetry 등의 관리자가 생겼다. 

# Poetry에 대해서

## Poetry가 하는 일

Poetry는 가상환경 관리자이자 패키지 매니저로, [PEP 518](https://www.python.org/dev/peps/pep-0518/)에서 소개하고있는 프로젝트의 빌드시스템을 정의하는 pyproject.toml파일을 사용하고 있다. Poetry는 pyproject.toml 파일에 개발자가 현재 환경에 설치한 패키지 버전과 목록을 함께 기록하고있으며, show 명령을 통해서 설치된 패키지와 그 패키지가 의존하는 의존성을 표기해준다.

## 설치

설치방법은 크게 두가지가 있는데, pypi를 통한 설치, poetry에서 제공하는 스크립트를 이용한 설치이다.

1. pypi를 통한 설치

    pypi는 pip 도구를 이용한 파이썬 패키지 설치에 사용되는 클라우드 패키지 저장소이다. 여기를 활용하기 위한 명령어는 다음과 같다.

    ``` bash
    $ pip install poetry
    ```

    만약 특정 버전을 설치하고 싶다면 아래 명령어를 입력하면 된다.

    ``` bash
    $ pip install poetry==0.12.0
    ```

    이런 식으로 설치할 수 있고, 설치 가능한 버전을 보고 싶다면 pip의 기능을 적당히 악용할 수 있다.

    ``` bash
    $ pip install poetry==

    ERROR: Could not find a version that satisfies the requirement poetry== (from versions: 0.1.0, 0.2.0, 0.3.0, 0.4.0, 0.4.0.post1, 0.4.1, 0.4.2, 0.5.0b1, 0.5.0b2, 0.5.0, 0.6.0, 0.6.1, 0.6.2, 0.6.3b1, 0.6.3b2, 0.6.3b3, 0.6.3b4, 0.6.3b5, 0.6.3b6, 0.6.3b7, 0.6.3, 0.6.4b1, 0.6.4, 0.6.5, 0.7.0b1, 0.7.0b2, 0.7.0b3, 0.7.0b4, 0.7.0, 0.7.1, 0.8.0a0, 0.8.0a1, 0.8.0a2, 0.8.0a3, 0.8.0a4, 0.8.0, 0.8.1a0, 0.8.1, 0.8.2, 0.8.3, 0.8.4, 0.8.5a0, 0.8.5, 0.8.6, 0.9.0a0, 0.9.0a1, 0.9.0a2, 0.9.0a3, 0.9.0, 0.9.1, 0.10.0a0, 0.10.0a1, 0.10.0a2, 0.10.0a3, 0.10.0, 0.10.1, 0.10.2, 0.10.3, 0.11.0a0, 0.11.0a1, 0.11.0a2, 0.11.0a3, 0.11.0a4, 0.11.0, 0.11.1, 0.11.2, 0.11.3, 0.11.4, 0.11.5, 0.12.0a0, 0.12.0a1, 0.12.0a2, 0.12.0a3, 0.12.0a4, 0.12.0a5, 0.12.0, 0.12.1, 0.12.2, 0.12.3, 0.12.4, 0.12.5, 0.12.6, 0.12.7, 0.12.8, 0.12.9, 0.12.10, 0.12.11, 0.12.12, 0.12.13, 0.12.14, 0.12.15, 0.12.16, 0.12.17, 1.0.0a0, 1.0.0a1, 1.0.0a2, 1.0.0a3, 1.0.0a4, 1.0.0a5, 1.0.0b1, 1.0.0b2, 1.0.0b3)
    ERROR: No matching distribution found for poetry==
    ```

    이러한 명령어를 이용해 pypi에 현재 설치가능하게 배포되어있는 버전을 확인할 수있다.

2. 스크립트를 이용한 설치

    poetry 개발자들은 get-poetry.py 스크립트도 만들어두었다. 그래서 해당 스크립트 파일을 다운받은 뒤 다음 명령어로 실행시켜 설치가 가능하다.

    ``` bash
    # get-poetry.py 스크립트를 받아와야 한다.
    $ curl -sSL https://raw.githubusercontent.com/sdispater/poetry/master/get-poetry.py 

    # 가장 최근에 릴리즈된 정식 버전 설치
    $ python3 get-poetry.py

    # 특정 버전 설치
    $ python3 get-poetry.py --version ${version}

    # 정식 릴리즈 전 프리뷰 버전 설치
    $ python3 get-poetry.py --preview
    ```

이 외에도 github에서 아직 배포되지 않은 코드를 직접 받아서 빌드하는 방법도 있는데, 수정중인 코드가 있을 수 있기 때문에 master 브랜치에서의 설치는 권장하지 않는다.

## 사용법

처음 poetry를 설치하고, 새로운 프로젝트를 생성하거나 기존에 사용중인 프로젝트에서 poetry에 맞게 초기화할 수 있다. 새 프로젝트 생성은

`$ poetry new my-package`

명령을 이용해 새로운 폴더(my-package)를 생성하면서 poetry 프로젝트 폴더구조를 만들어준다. 이때 만들어지는 폴더구조는 다음과 같다.

``` bash
my-package
├── pyproject.toml
├── README.rst
├── my_package
│   └── __init__.py
└── tests
    ├── __init__.py
    └── test_my_package

출처) poetry github repository
```

초기화는 init 명령을 이용해서 수행 가능하며, pyproject.toml파일을 생성한다. 