---
layout: post
title: Alembic을 사용하는 방법
subtitle: 내가 보려고 만드는 메뉴얼 시리즈
comments: true
categories: "Database"
tag: ["python", "Database", "Migration", "ORM", "SQLAlchemy"]
---

## Alembic이란

DB 마이그레이션은 기존에 있는 데이터를 다른 시스템에 이식하는 작업 등을 의미하는데, 여기서 다른 시스템은 다른 DB 구조가 되기도 한다. 만약에 어떤 데이터베이스에 특정 테이블을 추가하거나, 삭제, 수정하는 DDL과 DCL 다루는 작업을 하는 경우에는 쿼리을 그대로 실행해서 변경 작업을 진행해야 했다. 하지만 예전에 모놀리틱 구조에서는 DB의 스키마가 변경되면 시스템 복잡도만큼 작업량이 기하급수적으로 증가했다.

시스템 구조는 어쩔 수 없이 안에서 다뤄지는 데이터 구조에 의존하게 되는데, DB가 자주 변경되면 그때마다 서비스 전체가 변경되면서 생각지도 못한 코드들 까지도 변경되는 경우가 많아 오류를 검출하거나 수정하기가 아주 힘들다. 이런 코드 품질관리 문제를 위해 SVC 도구 등이 개발되었지만 DB는 쿼리를 이용해서 관리하려고 하면 작업이 만만치 않다.

마이그레이션 도구를 사용하면 이런 관리 작업이 한결 쉬워진다. 이 점은 모놀리틱 구조에서 MSA와 DevOps가 본격적으로 퍼지면서 더 중요해졌는데, DevOps의 경우에는 시스템이 운영되는 도중에 계속해서 새로운 개발이 이뤄지고, 이 변경사항이 다시 시스템 운영에 영향을 준다. MSA는 기존에 커다란 시스템 덩치를 기능단위로 잘게 쪼개서 개발 및 유지보수를 훨씬 쉽게 해준다. 기존의 개발자가 DB를 변경할 때 모든 시스템을 한번에 점검해야 했다면, MSA의 경우에는 특정 데이터 구조가 영향을 주는 시스템만 점검하면 되기 때문에 작업 범위가 훨씬 축소된다.

Alembic은 바로 이러한 DB migration 도구 중 하나이다.

### SQLAlchemy와의 관계

Alembic을 개발한 제작팀이 SQLAlchemy도 개발했기 때문에 Alembic은 SQLAlchemy의 하위 플러그인이다. Alembic에 대해 알기 전에는 SQLAlchemy만 이용해서 어떻게 DML 작업은 수행하더라도 DDL이나 DCL은 Raw query를 이용하거나 DDL, DCL에 해당하는 코드를 따로 작성해서 DB를 관리해야 했는데 이런 코드는 대개 일회성으로 실행되거나 사용 빈도가 많지 않기때문에 코드가 쉽게 잊혀진다.

Alembic은 이 부분을 revision단위로 관리하면서도 sqlalchemy의 connector 객체를 지원하기도 하고, meatadata 객체와 연산자 함수들을 이용해서 DDL, DCL을 위한 코드를 자동으로 생성해주기도 한다. 따라서 SQLAlchemy와 Alembic은 물과 물고기같은 관계라고 볼 수 있다.

## 최초 설정



## DB 초기화

### Revision 관리

## DB 구조 변경

### DB Upgrade

### DB Downgrade
